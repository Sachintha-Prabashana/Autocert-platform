<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoCert - My Listings</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb; /* Modern Blue */
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --radius: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* --- Header Styles (From Dashboard) --- */
        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #3b82f6 100%);
            color: white;
            padding: 1.5rem 0;
            box-shadow: 0 8px 32px rgba(30, 58, 138, 0.25);
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.05) 50%, transparent 70%);
            pointer-events: none;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.75rem;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            color: white;
            text-decoration: none;
        }

        .logo i {
            color: #10b981;
            font-size: 2rem;
            filter: drop-shadow(0 2px 4px rgba(16, 185, 129, 0.3));
        }

        .nav-bar {
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: 8px;
            align-items: center;
        }

        .nav-links li a {
            color: white;
            text-decoration: none;
            font-weight: 600;
            padding: 12px 20px;
            border-radius: 12px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .nav-links li a:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .nav-links li a.active {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(5, 150, 105, 0.3));
            border: 1px solid rgba(16, 185, 129, 0.4);
            color: #ffffff;
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.25);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .profile-trigger {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 10px 16px;
            border-radius: 12px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            color: white;
        }

        .profile-trigger:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .profile-dropdown {
            position: relative;
        }

        .profile-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(30, 58, 138, 0.25);
            padding: 12px;
            min-width: 220px;
            z-index: 1000;
            margin-top: 12px;
            border: 1px solid rgba(226, 232, 240, 0.8);
            backdrop-filter: blur(20px);
        }

        .profile-menu a {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            text-decoration: none;
            color: #334155;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .profile-menu a:hover {
            background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
            transform: translateX(4px);
        }

        .profile-menu hr {
            margin: 12px 0;
            border: none;
            border-top: 1px solid #e2e8f0;
        }

        .profile-menu a.logout {
            color: #dc2626;
        }

        .profile-menu a.logout:hover {
            background: linear-gradient(135deg, #fef2f2, #fee2e2);
        }
        
        /* Mobile menu toggle */
        .mobile-menu-toggle {
            display: none;
            flex-direction: column;
            cursor: pointer;
            padding: 8px;
        }

        .mobile-menu-toggle span {
            width: 25px;
            height: 3px;
            background: white;
            margin: 3px 0;
            transition: 0.3s;
            border-radius: 2px;
        }

        /* --- Main Layout --- */
        .main-content {
            max-width: 1280px;
            margin: 0 auto;
            padding: 40px 24px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .page-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* --- Filters (Tabs Style) --- */
        .status-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 32px;
            align-items: center;
            justify-content: space-between;
            background: white;
            padding: 16px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }

        .filter-group { display: flex; gap: 8px; flex-wrap: wrap; }

        .filter-btn {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            border: 1px solid transparent;
            background: transparent;
            color: var(--text-muted);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-btn:hover { background: var(--bg-body); color: var(--text-main); }
        
        .filter-btn.active {
            background-color: #eff6ff;
            color: var(--primary);
            border-color: #bfdbfe;
            font-weight: 600;
        }

        .combo-filter select {
            padding: 10px 36px 10px 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-size: 0.9rem;
            color: var(--text-main);
            cursor: pointer;
            background-color: #fff;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
        }

        /* --- Vehicle Grid --- */
        .vehicle-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 24px;
        }

        .vehicle-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }

        .vehicle-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: #cbd5e1;
        }

        .vehicle-image {
            height: 200px;
            background: #f1f5f9;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .vehicle-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s;
        }
        
        .vehicle-card:hover .vehicle-image img { transform: scale(1.05); }

        .vehicle-info { padding: 20px; }

        .vehicle-header-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .vehicle-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-main);
            margin: 0;
            line-height: 1.3;
        }

        /* Badge Styles */
        .status-badge {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 99px;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        .status-badge.approved { background: #dcfce7; color: #166534; }
        .status-badge.pending { background: #fef3c7; color: #92400e; }
        .status-badge.sold { background: #e0e7ff; color: #3730a3; }
        .status-badge.rejected { background: #fee2e2; color: #991b1b; }

        .vehicle-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px dashed var(--border);
        }

        .vehicle-price {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
        }

        .vehicle-date { font-size: 0.8rem; color: var(--text-muted); }

        .vehicle-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            padding: 0 20px 20px 20px;
        }

        .btn-card {
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            text-decoration: none;
        }

        .btn-edit { background: #f1f5f9; color: var(--text-main); }
        .btn-edit:hover { background: #e2e8f0; }

        .btn-delete { background: #fef2f2; color: var(--danger); }
        .btn-delete:hover { background: #fee2e2; }

        /* --- Modals --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            overflow-y: auto;
        }

        .modal-content {
            background-color: #fff;
            margin: 5% auto;
            width: 90%;
            max-width: 600px;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 { font-size: 1.25rem; font-weight: 600; color: var(--text-main); }
        
        .close-btn, .close {
            font-size: 1.5rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: color 0.2s;
        }
        .close-btn:hover { color: var(--danger); }

        .modal-body { padding: 24px; }

        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { margin-bottom: 16px; }
        
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-main);
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.95rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .modal-footer {
            padding: 16px 24px;
            background: #f8fafc;
            border-top: 1px solid var(--border);
            border-bottom-left-radius: 16px;
            border-bottom-right-radius: 16px;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .btn-secondary { background: white; border: 1px solid var(--border); color: var(--text-main); padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 500; }
        .btn-secondary:hover { background: #f1f5f9; }
        
        .btn-save { background: var(--primary); border: none; color: white; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 500; }
        .btn-save:hover { background: var(--primary-dark); }

        .btn-primary { background: var(--primary); border: none; color: white; padding: 10px 20px; border-radius: 8px; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; font-weight: 500;}
        .btn-primary:hover { background: var(--primary-dark); }

        /* --- Image Upload Area --- */
        .image-upload-section {
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            padding: 24px;
            text-align: center;
            background: #f8fafc;
            transition: border-color 0.2s;
        }
        .image-upload-section:hover { border-color: var(--primary); }
        .image-preview { display: flex; gap: 10px; margin-top: 16px; flex-wrap: wrap; }
        .image-preview-item { width: 80px; height: 80px; position: relative; border-radius: 8px; overflow: hidden; }
        .image-preview-item img { width: 100%; height: 100%; object-fit: cover; }
        .remove-image {
            position: absolute; top: 2px; right: 2px; background: rgba(0,0,0,0.6);
            color: white; width: 18px; height: 18px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; cursor: pointer;
        }

        /* --- Empty States & Loading --- */
        .no-vehicles, .loading-message, .error-message {
            grid-column: 1 / -1;
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            color: var(--text-muted);
        }
        .no-vehicles i, .loading-message i, .error-message i { font-size: 3rem; margin-bottom: 16px; opacity: 0.5; }
        .no-vehicles h3 { color: var(--text-main); margin-bottom: 8px; }

        /* Mobile Toggle */
        .mobile-menu-toggle { display: none; flex-direction: column; gap: 4px; cursor: pointer; }
        .mobile-menu-toggle span { width: 24px; height: 2px; background: var(--text-main); }

        @media (max-width: 768px) {
            .nav-bar { display: none; } /* Simplified mobile handling */
            .mobile-menu-toggle { display: flex; }
            .header-content { padding: 0 16px; }
            .main-content { padding: 24px 16px; }
            .status-filters { flex-direction: column; align-items: stretch; }
            .filter-group { justify-content: center; }
            .combo-filter { width: 100%; }
            .combo-filter select { width: 100%; }
            .form-row { grid-template-columns: 1fr; }
            /* Add mobile nav logic if needed, referencing old CSS for absolute positioning */
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="customer-dashboard.html" class="logo">
                <i class="fas fa-car"></i>
                <span>AutoCert</span>
            </a>
            
            <div class="mobile-menu-toggle" onclick="toggleMobileMenu()">
                <span></span>
                <span></span>
                <span></span>
            </div>
        
            <nav class="nav-bar">
                <ul class="nav-links" id="navLinks">
                    <li><a href="customer-dashboard.html"><i class="fas fa-home"></i> Dashboard</a></li>
                    <li><a href="test-ins.html"><i class="fas fa-clipboard-check"></i> Inspections</a></li>
                    <li><a href="my-listings.html" class="active"><i class="fas fa-list"></i> My Listings</a></li>
                    <li><a href="add-listning.html"><i class="fas fa-plus-circle"></i> List Vehicle</a></li>
                </ul>
            </nav>

            <div class="user-info">
                <div class="profile-dropdown">
                    <div class="profile-trigger" onclick="toggleProfileMenu()">
                        <i class="fas fa-user-circle" style="font-size: 2.2rem;"></i>
                        <div>
                            <div style="font-weight: 700;">Loading...</div>
                            <div style="font-size: 0.8rem; opacity: 0.9;">Premium Member</div>
                        </div>
                        <i class="fas fa-chevron-down" style="font-size: 0.8rem; opacity: 0.8;"></i>
                    </div>
                    <div id="profileMenu" class="profile-menu">
                        <a href="customer-dashboard.html">
                            <i class="fas fa-user"></i>
                            <span>Dashboard</span>
                        </a>
                        <hr>
                        <a href="#" class="logout" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Logout</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="main-content">
        <div class="page-header">
            <h1 class="page-title">
                My Vehicles
            </h1>
            <a href="add-listing.html" class="btn-primary">
                <i class="fas fa-plus"></i> Add Listing
            </a>
        </div>

        <div class="status-filters">
            <div class="filter-group">
                <button class="filter-btn active filter-btn-all" onclick="filterVehicles('all')">
                    All
                </button>
                <button class="filter-btn filter-btn-pending" onclick="filterVehicles('PENDING')">
                    <i class="fas fa-circle" style="font-size: 0.5rem; color: #f59e0b;"></i> Pending
                </button>
                <button class="filter-btn filter-btn-approved" onclick="filterVehicles('APPROVED')">
                    <i class="fas fa-circle" style="font-size: 0.5rem; color: #10b981;"></i> Approved
                </button>
                <button class="filter-btn filter-btn-sold" onclick="filterVehicles('SOLD')">
                    <i class="fas fa-circle" style="font-size: 0.5rem; color: #6366f1;"></i> Sold
                </button>
                <button class="filter-btn filter-btn-rejected" onclick="filterVehicles('REJECTED')">
                    <i class="fas fa-circle" style="font-size: 0.5rem; color: #ef4444;"></i> Rejected
                </button>
            </div>
            
            <div class="combo-filter">
                <select id="sortFilter" onchange="sortVehicles(this.value)">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="priceHigh">Price: High to Low</option>
                    <option value="priceLow">Price: Low to High</option>
                    <option value="make">Make (A-Z)</option>
                </select>
            </div>
        </div>

        <div id="vehicleGrid" class="vehicle-grid">
            <div class="loading-message">
                <i class="fas fa-circle-notch fa-spin"></i>
                <p>Loading your garage...</p>
            </div>
        </div>
    </div>

    <div id="updateProfileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Profile Settings</h2>
                <span class="close" onclick="closeProfileModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 24px;">
                    <img src="https://via.placeholder.com/100" alt="Profile" class="profile-pic" id="profileImage" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); margin-bottom: 12px;">
                    <br>
                    <label for="profilePicInput" style="color: var(--primary); cursor: pointer; font-weight: 500; font-size: 0.9rem;">
                        Change Photo
                    </label>
                    <input type="file" id="profilePicInput" accept="image/*" style="display: none;" onchange="previewImage(this)">
                </div>

                <form id="profileForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="firstName" class="form-label">First Name</label>
                            <input type="text" id="firstName" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="lastName" class="form-label">Last Name</label>
                            <input type="text" id="lastName" class="form-input" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="email" class="form-label">Email Address</label>
                        <input type="email" id="email" class="form-input" readonly style="background-color: #f1f5f9; color: #64748b;">
                    </div>
                    
                    <div class="form-group">
                        <label for="phoneNumber" class="form-label">Phone Number</label>
                        <input type="tel" id="phoneNumber" class="form-input" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeProfileModal()">Cancel</button>
                <button type="button" class="btn-save" onclick="saveProfile()">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="editVehicleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Listing</h2>
                <span class="close-btn" onclick="closeEditModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="image-upload-section">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: #cbd5e1; margin-bottom: 8px;"></i>
                    <p style="margin-bottom: 12px; font-size: 0.9rem; color: #64748b;">Click to upload new images</p>
                    <input type="file" id="vehicleImages" accept="image/*" multiple onchange="previewVehicleImages(this)" style="display: none;">
                    <button type="button" class="btn-secondary" onclick="document.getElementById('vehicleImages').click()">Select Files</button>
                    <div class="image-preview" id="imagePreview"></div>
                </div>
                
                <form id="editVehicleForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-make" class="form-label">Make</label>
                            <input type="text" id="edit-make" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-model" class="form-label">Model</label>
                            <input type="text" id="edit-model" class="form-input" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-year" class="form-label">Year</label>
                            <input type="number" id="edit-year" class="form-input" min="1900" max="2099" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-mileage" class="form-label">Mileage</label>
                            <input type="number" id="edit-mileage" class="form-input" min="0" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-description" class="form-label">Description</label>
                        <textarea id="edit-description" class="form-textarea" rows="3" required></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-price" class="form-label">Price (LKR)</label>
                            <input type="number" id="edit-price" class="form-input" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-contactPhone" class="form-label">Contact Phone</label>
                            <input type="tel" id="edit-contactPhone" class="form-input" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeEditModal()">Discard</button>
                <button type="button" class="btn-save" onclick="updateVehicle()">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        // ================== CONSTANTS ==================
        const API_BASE_USERS = "http://localhost:8080/api/users";
        const API_BASE_VEHICLES = "http://localhost:8080/api/vehicles";

        const editModal = document.getElementById("editVehicleModal");
        let currentVehicleId = null; 
        let vehicleImages = []; 

        // ================== TOKEN HELPERS ==================
        function getToken() { return localStorage.getItem("token"); }
        function saveToken(token) { localStorage.setItem("token", token); }
        function clearToken() { localStorage.removeItem("token"); }

        // ================== GLOBAL VARIABLES ==================
        let allVehicles = [];
        let currentFilter = 'all';

        // ================== PROFILE ==================
        async function loadUserProfile() {
            const token = getToken();
            if (!token) return;

            try {
                const res = await fetch(`${API_BASE_USERS}/me`, {
                    method: "GET",
                    headers: { "Authorization": "Bearer " + token, "Content-Type": "application/json" }
                });
                
                if (!res.ok) throw new Error("Failed to fetch user info");
                const user = await res.json();

                // Simple header update logic (adapted for new HTML structure if needed)
                // Note: The UI structure changed slightly, but IDs remain.
                
                const modalFields = ["firstName", "lastName", "email", "phoneNumber"];
                modalFields.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = user[id] || "";
                });

                // Update Header Profile Info
                const headerName = document.querySelector(".profile-trigger div div:first-child");
                if (headerName) headerName.textContent = `${user.firstName} ${user.lastName}`;

                const profileImg = document.getElementById("profileImage");
                if (profileImg) profileImg.src = user.profileImageUrl || "https://via.placeholder.com/100x100/1e40af/white?text=User";
            } catch (err) {
                console.error(err);
            }
        }

        // ================== LOAD USER'S VEHICLES ==================
        async function loadUserVehicles() {
            const grid = document.getElementById("vehicleGrid");
            if (!grid) return;

            const token = getToken();
            if (!token) {
                grid.innerHTML = `<div class="error-message"><i class="fas fa-lock"></i><p>Please login to view your vehicles.</p></div>`;
                return;
            }

            try {
                grid.innerHTML = `<div class="loading-message"><i class="fas fa-circle-notch fa-spin"></i><p>Loading your vehicles...</p></div>`;
                const vehiclesRes = await fetch(`${API_BASE_VEHICLES}/my-listings`, {
                    method: "GET",
                    headers: { "Authorization": "Bearer " + token, "Content-Type": "application/json" }
                });
                
                if (!vehiclesRes.ok) throw new Error("Failed to fetch user vehicles");
                allVehicles = await vehiclesRes.json();
                renderFilteredVehicles();
            } catch (err) {
                console.error("Error loading user vehicles:", err);
                grid.innerHTML = `<div class="error-message"><i class="fas fa-exclamation-circle"></i><p>Failed to load. <a href="#" onclick="loadUserVehicles()">Retry</a></p></div>`;
            }
        }

        // ================== FILTER VEHICLES BY STATUS ==================
        function filterVehicles(status) {
            currentFilter = status;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            
            if (status === 'all') document.querySelector('.filter-btn-all').classList.add('active');
            else if (status === 'PENDING') document.querySelector('.filter-btn-pending').classList.add('active');
            else if (status === 'APPROVED') document.querySelector('.filter-btn-approved').classList.add('active');
            else if (status === 'SOLD') document.querySelector('.filter-btn-sold').classList.add('active');
            else if (status === 'REJECTED') document.querySelector('.filter-btn-rejected').classList.add('active');
            
            renderFilteredVehicles();
        }

        // ================== SORT VEHICLES ==================
        function sortVehicles(sortBy) {
            if (!allVehicles || allVehicles.length === 0) return;
            let sortedVehicles = [...allVehicles];
            
            switch(sortBy) {
                case 'newest': sortedVehicles.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); break;
                case 'oldest': sortedVehicles.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt)); break;
                case 'priceHigh': sortedVehicles.sort((a, b) => (b.price || 0) - (a.price || 0)); break;
                case 'priceLow': sortedVehicles.sort((a, b) => (a.price || 0) - (b.price || 0)); break;
                case 'make': sortedVehicles.sort((a, b) => (a.make || '').localeCompare(b.make || '')); break;
            }
            allVehicles = sortedVehicles;
            renderFilteredVehicles();
        }

        // ================== RENDER FILTERED VEHICLES (UPDATED HTML STRUCTURE) ==================
        function renderFilteredVehicles() {
            const grid = document.getElementById("vehicleGrid");
            if (!grid || !allVehicles) return;

            let filteredVehicles = allVehicles;
            if (currentFilter !== 'all') {
                filteredVehicles = allVehicles.filter(vehicle => vehicle.status === currentFilter);
            }

            grid.innerHTML = "";

            if (!filteredVehicles || filteredVehicles.length === 0) {
                grid.innerHTML = currentFilter === 'all'
                    ? `<div class="no-vehicles">
                        <i class="fas fa-car"></i>
                        <h3>Your garage is empty</h3>
                        <p>You haven't listed any vehicles yet.</p>
                        <a href="add-listing.html" class="btn-primary" style="margin-top:10px;">List Your First Vehicle</a>
                       </div>`
                    : `<div class="no-vehicles">
                        <i class="fas fa-search"></i>
                        <h3>No ${currentFilter.toLowerCase()} vehicles</h3>
                        <button class="btn-secondary" onclick="filterVehicles('all')">View All Listings</button>
                       </div>`;
                return;
            }

            filteredVehicles.forEach(v => {
                let statusClass = 'pending';
                let statusText = 'Pending';
                
                switch (v.status) {
                    case 'APPROVED': statusClass = 'approved'; statusText = 'Approved'; break;
                    case 'REJECTED': statusClass = 'rejected'; statusText = 'Rejected'; break;
                    case 'SOLD': statusClass = 'sold'; statusText = 'Sold'; break;
                }

                // First Image Logic
                let imageHtml = '';
                if (v.images && v.images.length > 0 && v.images[0]) {
                    imageHtml = `<img src="${v.images[0]}" alt="${v.make} ${v.model}" onerror="this.src='https://via.placeholder.com/400x300?text=No+Image'">`;
                } else {
                    imageHtml = `<i class="fas fa-car" style="font-size: 3rem; color: #cbd5e1;"></i>`;
                }

                const cardDiv = document.createElement("div");
                cardDiv.classList.add("vehicle-card");
                
                // Updated Card HTML to match new CSS
                cardDiv.innerHTML = `
                    <div class="vehicle-image">
                        ${imageHtml}
                    </div>
                    <div class="vehicle-info">
                        <div class="vehicle-header-row">
                            <h3 class="vehicle-title">${v.year} ${v.make} ${v.model}</h3>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <div class="vehicle-meta">
                            <span class="vehicle-price">${formatPrice(v.price)}</span>
                            <span class="vehicle-date"><i class="far fa-clock"></i> ${formatDate(v.createdAt)}</span>
                        </div>
                    </div>
                    <div class="vehicle-actions">
                        <a href="#" class="btn-card btn-edit" onclick="openEditModal(${v.id})">
                            <i class="fas fa-pen"></i> Edit
                        </a>
                        <button class="btn-card btn-delete" onclick="deleteVehicle('${v.id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                `;
                grid.appendChild(cardDiv);
            });
        }

        // ================== DELETE VEHICLE ==================
        async function deleteVehicle(vehicleId) {
            if (!confirm("Delete this listing permanently?")) return;
            const token = getToken();
            if (!token) return alert("Please login first!");

            try {
                const res = await fetch(`${API_BASE_VEHICLES}/${vehicleId}`, {
                    method: "DELETE",
                    headers: { "Authorization": "Bearer " + token }
                });
                if (!res.ok) throw new Error("Failed to delete");
                
                // Minimal visual feedback usually better than alert, but keeping alert as requested logic
                alert("Listing deleted.");
                loadUserVehicles();
            } catch (err) {
                console.error(err);
                alert("Could not delete vehicle.");
            }
        }

        // ================== OPEN EDIT MODAL ==================
        async function openEditModal(vehicleId) {
            currentVehicleId = vehicleId;
            try {
                const token = getToken();
                const res = await fetch(`${API_BASE_VEHICLES}/my-listings/${vehicleId}`, {
                    method: "GET",
                    headers: { "Authorization": "Bearer " + token, "Content-Type": "application/json" }
                });
                
                if (!res.ok) throw new Error("Failed to fetch vehicle");
                const vehicle = await res.json();

                document.getElementById("edit-make").value = vehicle.make || "";
                document.getElementById("edit-model").value = vehicle.model || "";
                document.getElementById("edit-year").value = vehicle.year || "";
                document.getElementById("edit-mileage").value = vehicle.mileage || "";
                document.getElementById("edit-description").value = vehicle.description || "";
                document.getElementById("edit-price").value = vehicle.price || "";
                document.getElementById("edit-contactPhone").value = vehicle.contactPhone || "";

                vehicleImages = vehicle.imageUrls || [];
                updateImagePreview();
                editModal.style.display = "block";
            } catch (err) {
                console.error(err);
                alert("Failed to load details");
            }
        }

        // ================== IMAGE FUNCTIONS ==================
        function previewVehicleImages(input) {
            if (input.files && input.files.length > 0) {
                for (let i = 0; i < input.files.length; i++) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        vehicleImages.push(e.target.result);
                        updateImagePreview();
                    };
                    reader.readAsDataURL(input.files[i]);
                }
            }
        }

        function updateImagePreview() {
            const previewContainer = document.getElementById("imagePreview");
            if (!previewContainer) return;
            previewContainer.innerHTML = "";
            vehicleImages.forEach((img, index) => {
                const previewItem = document.createElement("div");
                previewItem.className = "image-preview-item";
                previewItem.innerHTML = `<img src="${img}"><span class="remove-image" onclick="removeImage(${index})">&times;</span>`;
                previewContainer.appendChild(previewItem);
            });
        }

        function removeImage(index) {
            vehicleImages.splice(index, 1);
            updateImagePreview();
        }

        // ================== UPDATE VEHICLE ==================
        async function updateVehicle() {
            const token = getToken();
            if (!token) return alert("Please login first!");

            const updatedVehicle = {
                make: document.getElementById("edit-make").value,
                model: document.getElementById("edit-model").value,
                year: parseInt(document.getElementById("edit-year").value),
                mileage: parseInt(document.getElementById("edit-mileage").value),
                description: document.getElementById("edit-description").value,
                price: parseFloat(document.getElementById("edit-price").value),
                contactPhone: document.getElementById("edit-contactPhone").value,
                imageUrls: vehicleImages
            };

            try {
                const res = await fetch(`${API_BASE_VEHICLES}/my-listings/${currentVehicleId}`, {
                    method: "PUT",
                    headers: { "Authorization": "Bearer " + token, "Content-Type": "application/json" },
                    body: JSON.stringify(updatedVehicle)
                });

                if (!res.ok) throw new Error("Update failed");
                alert("Saved successfully!");
                closeEditModal();
                loadUserVehicles();
            } catch (err) {
                console.error(err);
                alert("Update failed");
            }
        }

        function closeEditModal() { editModal.style.display = "none"; vehicleImages = []; }

        // ================== UTILS ==================
        function formatPrice(price) {
            if (!price) return "N/A";
            return new Intl.NumberFormat('en-LK', { style: 'currency', currency: 'LKR', maximumFractionDigits: 0 }).format(price);
        }

        function formatDate(dateString) {
            if (!dateString) return "";
            return new Date(dateString).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        // ================== UI TOGGLES ==================
        function viewProfile() {
            const modal = document.getElementById('updateProfileModal');
            if (modal) modal.style.display = 'block';
            toggleProfileMenu();
        }
        function closeProfileModal() { document.getElementById('updateProfileModal').style.display = 'none'; }
        
        function toggleProfileMenu() {
            const menu = document.getElementById('profileMenu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }
        function toggleMobileMenu() {
            document.getElementById('navLinks').classList.toggle('active');
        }

        function logout() {
            if (confirm("Logout of AutoCert?")) {
                clearToken();
                window.location.href = "/Frontend/index.html";
            }
        }
        
        function scheduleInspection() { window.location.href = '/Frontend/pages/test-ins.html'; }

        // Close modals on outside click
        window.onclick = function(event) {
            if (event.target == document.getElementById('updateProfileModal')) closeProfileModal();
            if (event.target == document.getElementById('editVehicleModal')) closeEditModal();
        }

        // Profile Image Preview (Modal)
        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) { document.getElementById('profileImage').src = e.target.result; };
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function saveProfile() {
            // Profile save logic kept intact...
            const token = getToken();
            if (!token) { alert("Please login first!"); return; }
            const formData = new FormData();
            formData.append("firstName", document.getElementById("firstName").value);
            formData.append("lastName", document.getElementById("lastName").value);
            formData.append("phone", document.getElementById("phoneNumber").value);
            const imageFile = document.getElementById("profilePicInput")?.files[0];
            if (imageFile) formData.append("image", imageFile);

            try {
                const res = await fetch(`${API_BASE_USERS}/update`, {
                    method: "PUT",
                    headers: { "Authorization": "Bearer " + token },
                    body: formData
                });
                if (!res.ok) throw new Error("Profile update failed");
                alert("Profile updated!");
                closeProfileModal();
            } catch(err) {
                console.error(err);
                alert("Could not update profile");
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            loadUserProfile();
            loadUserVehicles();
        });
    </script>
</body>
</html>